<Window x:Class="VideoManager.Views.EditDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:vm="clr-namespace:VideoManager.ViewModels"
        mc:Ignorable="d"
        Title="编辑视频信息"
        Height="720" Width="520"
        MinHeight="560" MinWidth="420"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResizeWithGrip"
        Style="{StaticResource MaterialDesignWindow}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="14"
        Background="{DynamicResource MaterialDesignPaper}"
        FontFamily="{DynamicResource MaterialDesignFont}"
        d:DataContext="{d:DesignInstance Type=vm:EditViewModel, IsDesignTimeCreatable=False}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:ColorToSolidBrushConverter x:Key="ColorToSolidBrushConverter"
                                          xmlns:local="clr-namespace:VideoManager.Views"/>
        <local:ColorToForegroundConverter x:Key="ColorToForegroundConverter"
                                          xmlns:local="clr-namespace:VideoManager.Views"/>
    </Window.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <!-- Header -->
            <RowDefinition Height="Auto"/>
            <!-- Error message -->
            <RowDefinition Height="Auto"/>
            <!-- Title field -->
            <RowDefinition Height="Auto"/>
            <!-- Description field -->
            <RowDefinition Height="Auto"/>
            <!-- Categories section -->
            <RowDefinition Height="Auto"/>
            <!-- Tags section -->
            <RowDefinition Height="*"/>
            <!-- Color palette popup -->
            <RowDefinition Height="Auto"/>
            <!-- Saving indicator -->
            <RowDefinition Height="Auto"/>
            <!-- Action buttons -->
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ==================== Header ==================== -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,12">
            <md:PackIcon Kind="FileEdit"
                         Width="28" Height="28"
                         VerticalAlignment="Center"
                         Foreground="{DynamicResource PrimaryHueMidBrush}"
                         Margin="0,0,10,0"/>
            <TextBlock Text="编辑视频信息"
                       FontSize="20"
                       FontWeight="Medium"
                       VerticalAlignment="Center"/>
        </StackPanel>

        <!-- ==================== Error Message ==================== -->
        <md:Card Grid.Row="1"
                 Margin="0,0,0,12"
                 Background="#FFF8E1"
                 UniformCornerRadius="4"
                 Padding="12,8"
                 Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <md:PackIcon Kind="AlertCircleOutline"
                             Width="20" Height="20"
                             VerticalAlignment="Center"
                             Foreground="#F44336"
                             Margin="0,0,8,0"/>
                <TextBlock Text="{Binding ErrorMessage}"
                           VerticalAlignment="Center"
                           Foreground="#D32F2F"
                           TextWrapping="Wrap"
                           FontSize="13"/>
            </StackPanel>
        </md:Card>

        <!-- ==================== Title Field ==================== -->
        <TextBox Grid.Row="2"
                 Text="{Binding Title, UpdateSourceTrigger=PropertyChanged}"
                 md:HintAssist.Hint="视频标题 *"
                 md:HintAssist.IsFloating="True"
                 md:TextFieldAssist.HasClearButton="True"
                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                 Margin="0,0,0,12"
                 MaxLength="200"/>

        <!-- ==================== Description Field ==================== -->
        <TextBox Grid.Row="3"
                 Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                 md:HintAssist.Hint="视频描述"
                 md:HintAssist.IsFloating="True"
                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                 AcceptsReturn="True"
                 TextWrapping="Wrap"
                 VerticalScrollBarVisibility="Auto"
                 MinHeight="80"
                 MaxHeight="120"
                 Margin="0,0,0,12"/>

        <!-- ==================== Categories Section ==================== -->
        <md:Card Grid.Row="4"
                 md:ElevationAssist.Elevation="Dp1"
                 UniformCornerRadius="4"
                 Margin="0,0,0,12">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Current Categories Header -->
                <Border Grid.Row="0"
                        Background="{DynamicResource PrimaryHueLightBrush}"
                        Padding="12,8">
                    <StackPanel Orientation="Horizontal">
                        <md:PackIcon Kind="FolderMultiple"
                                     Width="18" Height="18"
                                     VerticalAlignment="Center"
                                     Margin="0,0,8,0"/>
                        <TextBlock VerticalAlignment="Center" FontWeight="Medium">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="当前分类 ({0})">
                                    <Binding Path="VideoCategories.Count"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <!-- Current Categories List -->
                <ItemsControl Grid.Row="1"
                              ItemsSource="{Binding VideoCategories}"
                              Padding="4"
                              MinHeight="30">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="2" Padding="6,4" CornerRadius="12"
                                    Background="{DynamicResource PrimaryHueLightBrush}">
                                <StackPanel Orientation="Horizontal">
                                    <md:PackIcon Kind="Folder" Width="14" Height="14"
                                                 VerticalAlignment="Center" Margin="0,0,4,0"/>
                                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center" FontSize="12"/>
                                    <Button Command="{Binding DataContext.RemoveCategoryCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            Style="{StaticResource MaterialDesignIconForegroundButton}"
                                            ToolTip="移除此分类"
                                            Width="22" Height="22" Padding="1" Margin="4,0,0,0">
                                        <md:PackIcon Kind="CloseCircleOutline" Width="14" Height="14" Foreground="#EF5350"/>
                                    </Button>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>

                <Separator Grid.Row="2" Margin="8,0"/>

                <!-- Available Categories Header -->
                <Border Grid.Row="3"
                        Background="{DynamicResource MaterialDesignToolBarBackground}"
                        Padding="12,8">
                    <StackPanel Orientation="Horizontal">
                        <md:PackIcon Kind="FolderPlus"
                                     Width="18" Height="18"
                                     VerticalAlignment="Center"
                                     Margin="0,0,8,0"/>
                        <TextBlock VerticalAlignment="Center" FontWeight="Medium">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="可用分类 ({0})">
                                    <Binding Path="AvailableCategories.Count"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <!-- Available Categories List -->
                <ItemsControl Grid.Row="4"
                              ItemsSource="{Binding AvailableCategories}"
                              Padding="4"
                              MinHeight="30">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="2" Padding="6,4" CornerRadius="12"
                                    Background="{DynamicResource MaterialDesignToolBarBackground}"
                                    Cursor="Hand">
                                <StackPanel Orientation="Horizontal">
                                    <md:PackIcon Kind="FolderOutline" Width="14" Height="14"
                                                 VerticalAlignment="Center" Margin="0,0,4,0"/>
                                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center" FontSize="12"/>
                                    <Button Command="{Binding DataContext.AddCategoryCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            Style="{StaticResource MaterialDesignIconForegroundButton}"
                                            ToolTip="添加此分类"
                                            Width="22" Height="22" Padding="1" Margin="4,0,0,0">
                                        <md:PackIcon Kind="PlusCircleOutline" Width="14" Height="14"
                                                     Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                    </Button>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </Grid>
        </md:Card>

        <!-- ==================== Tags Section ==================== -->
        <md:Card Grid.Row="5"
                 md:ElevationAssist.Elevation="Dp1"
                 UniformCornerRadius="4"
                 Margin="0,0,0,12">
            <Grid>
                <Grid.RowDefinitions>
                    <!-- Tags header -->
                    <RowDefinition Height="Auto"/>
                    <!-- Current tags -->
                    <RowDefinition Height="*"/>
                    <!-- Separator -->
                    <RowDefinition Height="Auto"/>
                    <!-- Available tags header -->
                    <RowDefinition Height="Auto"/>
                    <!-- Available tags -->
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Current Tags Header -->
                <Border Grid.Row="0"
                        Background="{DynamicResource PrimaryHueLightBrush}"
                        Padding="12,8">
                    <StackPanel Orientation="Horizontal">
                        <md:PackIcon Kind="TagMultiple"
                                     Width="18" Height="18"
                                     VerticalAlignment="Center"
                                     Margin="0,0,8,0"/>
                        <TextBlock VerticalAlignment="Center" FontWeight="Medium">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="当前标签 ({0})">
                                    <Binding Path="VideoTags.Count"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <!-- Current Tags List -->
                <ListBox Grid.Row="1"
                         ItemsSource="{Binding VideoTags}"
                         SelectedItem="{Binding SelectedVideoTag}"
                         MinHeight="60"
                         Background="Transparent"
                         BorderThickness="0"
                         Padding="4">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0"
                                            Orientation="Horizontal"
                                            VerticalAlignment="Center">
                                    <!-- Color indicator circle -->
                                    <Ellipse Width="14" Height="14"
                                             Fill="{Binding Color, Converter={StaticResource ColorToSolidBrushConverter}}"
                                             VerticalAlignment="Center"
                                             Margin="0,0,6,0"/>
                                    <TextBlock Text="{Binding Name}"
                                               VerticalAlignment="Center"
                                               FontSize="13"/>
                                </StackPanel>

                                <!-- Color picker button -->
                                <Button Grid.Column="1"
                                        Command="{Binding DataContext.PickColorCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}"
                                        Style="{StaticResource MaterialDesignIconForegroundButton}"
                                        ToolTip="选择颜色"
                                        Width="28" Height="28"
                                        Padding="2">
                                    <md:PackIcon Kind="Palette"
                                                 Width="16" Height="16"
                                                 Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                </Button>

                                <Button Grid.Column="2"
                                        Command="{Binding DataContext.RemoveTagCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                        Style="{StaticResource MaterialDesignIconForegroundButton}"
                                        ToolTip="移除此标签"
                                        Width="28" Height="28"
                                        Padding="2">
                                    <md:PackIcon Kind="CloseCircleOutline"
                                                 Width="18" Height="18"
                                                 Foreground="#EF5350"/>
                                </Button>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>

                    <!-- Empty state for current tags -->
                    <ListBox.Style>
                        <Style TargetType="ListBox" BasedOn="{StaticResource {x:Type ListBox}}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding VideoTags.Count}" Value="0">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate>
                                                <TextBlock Text="暂无标签"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                           Opacity="0.6"
                                                           Margin="0,12"/>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ListBox.Style>
                </ListBox>

                <!-- Separator -->
                <Separator Grid.Row="2" Margin="8,0"/>

                <!-- Available Tags Header -->
                <Border Grid.Row="3"
                        Background="{DynamicResource MaterialDesignToolBarBackground}"
                        Padding="12,8">
                    <StackPanel Orientation="Horizontal">
                        <md:PackIcon Kind="TagPlus"
                                     Width="18" Height="18"
                                     VerticalAlignment="Center"
                                     Margin="0,0,8,0"/>
                        <TextBlock VerticalAlignment="Center" FontWeight="Medium">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="可用标签 ({0})">
                                    <Binding Path="AvailableTags.Count"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <!-- Available Tags List -->
                <ListBox Grid.Row="4"
                         ItemsSource="{Binding AvailableTags}"
                         SelectedItem="{Binding SelectedAvailableTag}"
                         MinHeight="60"
                         Background="Transparent"
                         BorderThickness="0"
                         Padding="4">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0"
                                            Orientation="Horizontal"
                                            VerticalAlignment="Center">
                                    <!-- Color indicator circle -->
                                    <Ellipse Width="14" Height="14"
                                             Fill="{Binding Color, Converter={StaticResource ColorToSolidBrushConverter}}"
                                             VerticalAlignment="Center"
                                             Margin="0,0,6,0"/>
                                    <TextBlock Text="{Binding Name}"
                                               VerticalAlignment="Center"
                                               FontSize="13"/>
                                </StackPanel>

                                <Button Grid.Column="1"
                                        Command="{Binding DataContext.AddTagCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                        Style="{StaticResource MaterialDesignIconForegroundButton}"
                                        ToolTip="添加此标签"
                                        Width="28" Height="28"
                                        Padding="2">
                                    <md:PackIcon Kind="PlusCircleOutline"
                                                 Width="18" Height="18"
                                                 Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                </Button>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>

                    <!-- Empty state for available tags -->
                    <ListBox.Style>
                        <Style TargetType="ListBox" BasedOn="{StaticResource {x:Type ListBox}}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding AvailableTags.Count}" Value="0">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate>
                                                <TextBlock Text="没有更多可用标签"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                           Opacity="0.6"
                                                           Margin="0,12"/>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ListBox.Style>
                </ListBox>
            </Grid>
        </md:Card>

        <!-- ==================== Color Palette ==================== -->
        <md:Card Grid.Row="6"
                 md:ElevationAssist.Elevation="Dp2"
                 UniformCornerRadius="4"
                 Margin="0,0,0,12"
                 Padding="12"
                 Visibility="{Binding IsColorPickerVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                    <md:PackIcon Kind="Palette"
                                 Width="18" Height="18"
                                 VerticalAlignment="Center"
                                 Foreground="{DynamicResource PrimaryHueMidBrush}"
                                 Margin="0,0,8,0"/>
                    <TextBlock Text="{Binding ColorPickerTitle}"
                               FontWeight="Medium"
                               VerticalAlignment="Center"
                               FontSize="13"/>
                </StackPanel>

                <!-- Material Design color palette -->
                <ItemsControl ItemsSource="{Binding ColorPalette}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Command="{Binding DataContext.SelectColorCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                    CommandParameter="{Binding}"
                                    Width="28" Height="28"
                                    Margin="2"
                                    Padding="0"
                                    ToolTip="{Binding}"
                                    Cursor="Hand">
                                <Button.Template>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="ColorBorder"
                                                Background="{Binding Converter={StaticResource ColorToSolidBrushConverter}}"
                                                CornerRadius="14"
                                                BorderThickness="2"
                                                BorderBrush="Transparent"
                                                Width="28" Height="28">
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="ColorBorder" Property="BorderBrush"
                                                        Value="{DynamicResource MaterialDesignBody}"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Button.Template>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Clear color / Cancel buttons -->
                <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                    <Button Command="{Binding SelectColorCommand}"
                            Style="{StaticResource MaterialDesignOutlinedButton}"
                            Padding="8,4"
                            Height="28"
                            FontSize="11"
                            ToolTip="使用默认主题色">
                        <StackPanel Orientation="Horizontal">
                            <md:PackIcon Kind="FormatColorReset" Width="14" Height="14"
                                         VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBlock Text="默认颜色" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding CancelColorPickerCommand}"
                            Style="{StaticResource MaterialDesignFlatButton}"
                            Padding="8,4"
                            Height="28"
                            FontSize="11"
                            Margin="8,0,0,0">
                        <TextBlock Text="取消" VerticalAlignment="Center"/>
                    </Button>
                </StackPanel>
            </StackPanel>
        </md:Card>

        <!-- ==================== Saving Indicator ==================== -->
        <StackPanel Grid.Row="7" Margin="0,0,0,8"
                    Visibility="{Binding IsSaving, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ProgressBar IsIndeterminate="True"
                         Height="4"/>
            <TextBlock Text="正在保存..."
                       HorizontalAlignment="Center"
                       Margin="0,4,0,0"
                       FontSize="12"
                       Foreground="{DynamicResource MaterialDesignBodyLight}"/>
        </StackPanel>

        <!-- ==================== Action Buttons ==================== -->
        <Grid Grid.Row="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Save button -->
            <Button Grid.Column="1"
                    Command="{Binding SaveCommand}"
                    Style="{StaticResource MaterialDesignRaisedButton}"
                    Margin="0,0,8,0"
                    Padding="20,8"
                    ToolTip="保存修改">
                <StackPanel Orientation="Horizontal">
                    <md:PackIcon Kind="ContentSave" VerticalAlignment="Center" Margin="0,0,6,0"/>
                    <TextBlock Text="保存" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <!-- Cancel/Close button -->
            <Button Grid.Column="2"
                    x:Name="CloseButton"
                    Click="CloseButton_Click"
                    Style="{StaticResource MaterialDesignOutlinedButton}"
                    Padding="20,8"
                    ToolTip="关闭编辑窗口">
                <StackPanel Orientation="Horizontal">
                    <md:PackIcon Kind="Close" VerticalAlignment="Center" Margin="0,0,6,0"/>
                    <TextBlock Text="关闭" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>
    </Grid>
</Window>
