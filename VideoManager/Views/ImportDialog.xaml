<Window x:Class="VideoManager.Views.ImportDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:vm="clr-namespace:VideoManager.ViewModels"
        xmlns:local="clr-namespace:VideoManager.Views"
        mc:Ignorable="d"
        Title="导入视频"
        Height="620" Width="700"
        MinHeight="500" MinWidth="550"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResizeWithGrip"
        Style="{StaticResource MaterialDesignWindow}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="14"
        Background="{DynamicResource MaterialDesignPaper}"
        FontFamily="{DynamicResource MaterialDesignFont}"
        d:DataContext="{d:DesignInstance Type=vm:ImportViewModel, IsDesignTimeCreatable=False}">

    <Window.Resources>
        <local:FileSizeFormatConverter x:Key="FileSizeFormatConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- Inverse boolean converter for enabling/disabling controls -->
        <local:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
    </Window.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <!-- Header -->
            <RowDefinition Height="Auto"/>
            <!-- Source folder selection -->
            <RowDefinition Height="Auto"/>
            <!-- Library path selection -->
            <RowDefinition Height="Auto"/>
            <!-- Options row (Move/Copy toggle + Scan button) -->
            <RowDefinition Height="Auto"/>
            <!-- Scanned files list -->
            <RowDefinition Height="*"/>
            <!-- Progress area -->
            <RowDefinition Height="Auto"/>
            <!-- Status message -->
            <RowDefinition Height="Auto"/>
            <!-- Action buttons -->
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ==================== Header ==================== -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,16">
            <md:PackIcon Kind="Import"
                         Width="28" Height="28"
                         VerticalAlignment="Center"
                         Foreground="{DynamicResource PrimaryHueMidBrush}"
                         Margin="0,0,10,0"/>
            <TextBlock Text="批量导入视频"
                       FontSize="20"
                       FontWeight="Medium"
                       VerticalAlignment="Center"/>
        </StackPanel>

        <!-- ==================== Source Folder Selection ==================== -->
        <Grid Grid.Row="1" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBox Grid.Column="0"
                     Text="{Binding SelectedFolderPath, UpdateSourceTrigger=PropertyChanged}"
                     md:HintAssist.Hint="选择源文件夹路径..."
                     md:HintAssist.IsFloating="True"
                     md:TextFieldAssist.HasClearButton="True"
                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                     Margin="0,0,8,0"
                     VerticalAlignment="Center"
                     IsReadOnly="True"/>

            <Button Grid.Column="1"
                    x:Name="BrowseSourceButton"
                    Click="BrowseSourceButton_Click"
                    Style="{StaticResource MaterialDesignOutlinedButton}"
                    ToolTip="浏览文件夹"
                    VerticalAlignment="Center"
                    Padding="12,6">
                <StackPanel Orientation="Horizontal">
                    <md:PackIcon Kind="FolderOpen" VerticalAlignment="Center" Margin="0,0,4,0"/>
                    <TextBlock Text="浏览" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- ==================== Library Path Selection ==================== -->
        <Grid Grid.Row="2" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBox Grid.Column="0"
                     Text="{Binding LibraryPath, UpdateSourceTrigger=PropertyChanged}"
                     md:HintAssist.Hint="视频库目标路径..."
                     md:HintAssist.IsFloating="True"
                     md:TextFieldAssist.HasClearButton="True"
                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                     Margin="0,0,8,0"
                     VerticalAlignment="Center"
                     IsReadOnly="True"/>

            <Button Grid.Column="1"
                    x:Name="BrowseLibraryButton"
                    Click="BrowseLibraryButton_Click"
                    Style="{StaticResource MaterialDesignOutlinedButton}"
                    ToolTip="浏览目标文件夹"
                    VerticalAlignment="Center"
                    Padding="12,6">
                <StackPanel Orientation="Horizontal">
                    <md:PackIcon Kind="FolderOpen" VerticalAlignment="Center" Margin="0,0,4,0"/>
                    <TextBlock Text="浏览" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- ==================== Options Row ==================== -->
        <Grid Grid.Row="3" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Move/Copy toggle -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                <md:PackIcon Kind="ContentCopy"
                             Width="18" Height="18"
                             VerticalAlignment="Center"
                             Margin="0,0,6,0"
                             Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                <TextBlock Text="复制"
                           VerticalAlignment="Center"
                           Margin="0,0,8,0"
                           Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                <ToggleButton Style="{StaticResource MaterialDesignSwitchToggleButton}"
                              IsChecked="{Binding MoveFiles}"
                              ToolTip="切换复制/移动模式"
                              VerticalAlignment="Center"/>
                <TextBlock Text="移动"
                           VerticalAlignment="Center"
                           Margin="8,0,0,0"
                           Foreground="{DynamicResource MaterialDesignBodyLight}"/>
            </StackPanel>

            <!-- Scan button -->
            <Button Grid.Column="2"
                    Command="{Binding ScanFolderCommand}"
                    Style="{StaticResource MaterialDesignRaisedButton}"
                    ToolTip="扫描文件夹中的视频文件"
                    Padding="16,6">
                <StackPanel Orientation="Horizontal">
                    <md:PackIcon Kind="FolderSearch" VerticalAlignment="Center" Margin="0,0,6,0"/>
                    <TextBlock Text="扫描" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- ==================== Scanned Files List ==================== -->
        <md:Card Grid.Row="4"
                 md:ElevationAssist.Elevation="Dp1"
                 UniformCornerRadius="4"
                 Margin="0,0,0,12">
            <DockPanel>
                <!-- List header -->
                <Border DockPanel.Dock="Top"
                        Background="{DynamicResource PrimaryHueLightBrush}"
                        Padding="12,8">
                    <StackPanel Orientation="Horizontal">
                        <md:PackIcon Kind="FileVideo"
                                     Width="18" Height="18"
                                     VerticalAlignment="Center"
                                     Margin="0,0,8,0"/>
                        <TextBlock VerticalAlignment="Center" FontWeight="Medium">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="扫描结果 ({0} 个文件)">
                                    <Binding Path="ScannedFiles.Count"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <!-- Scanning indicator -->
                <ProgressBar DockPanel.Dock="Top"
                             IsIndeterminate="True"
                             Visibility="{Binding IsScanning, Converter={StaticResource BooleanToVisibilityConverter}}"
                             Height="4"/>

                <!-- Empty state -->
                <TextBlock Text="请选择文件夹并点击扫描"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           FontSize="14"
                           Foreground="{DynamicResource MaterialDesignBodyLight}"
                           Opacity="0.6">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ScannedFiles.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <!-- File list -->
                <ListView ItemsSource="{Binding ScannedFiles}"
                          VirtualizingStackPanel.IsVirtualizing="True"
                          VirtualizingStackPanel.VirtualizationMode="Recycling"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                          Background="Transparent"
                          BorderThickness="0">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="文件名" Width="380"
                                            DisplayMemberBinding="{Binding FileName}"/>
                            <GridViewColumn Header="大小" Width="100">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding FileSize, Converter={StaticResource FileSizeFormatConverter}}"
                                                   TextAlignment="Right"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Header="路径" Width="160"
                                            DisplayMemberBinding="{Binding FilePath}"/>
                        </GridView>
                    </ListView.View>
                </ListView>
            </DockPanel>
        </md:Card>

        <!-- ==================== Progress Bar ==================== -->
        <StackPanel Grid.Row="5" Margin="0,0,0,8"
                    Visibility="{Binding IsImporting, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ProgressBar Value="{Binding Progress, Mode=OneWay}"
                         Minimum="0" Maximum="100"
                         Height="8"
                         md:TransitionAssist.DisableTransitions="True"/>
            <Grid Margin="0,4,0,0">
                <TextBlock HorizontalAlignment="Left"
                           FontSize="12"
                           Text="{Binding EstimatedTimeRemaining}"
                           Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                <TextBlock HorizontalAlignment="Right"
                           FontSize="12"
                           Foreground="{DynamicResource MaterialDesignBodyLight}">
                    <TextBlock.Text>
                        <Binding Path="Progress" StringFormat="{}{0:F0}%"/>
                    </TextBlock.Text>
                </TextBlock>
            </Grid>
        </StackPanel>

        <!-- ==================== Status Message ==================== -->
        <Border Grid.Row="6" Margin="0,0,0,12"
                Padding="10,6"
                CornerRadius="4"
                Background="{DynamicResource MaterialDesignToolBarBackground}">
            <StackPanel Orientation="Horizontal">
                <md:PackIcon Kind="InformationOutline"
                             Width="16" Height="16"
                             VerticalAlignment="Center"
                             Margin="0,0,8,0"
                             Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                <TextBlock Text="{Binding StatusMessage, TargetNullValue='就绪'}"
                           VerticalAlignment="Center"
                           FontSize="13"
                           Foreground="{DynamicResource MaterialDesignBodyLight}"
                           TextTrimming="CharacterEllipsis"/>
            </StackPanel>
        </Border>

        <!-- ==================== Action Buttons ==================== -->
        <Grid Grid.Row="7">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Import button -->
            <Button Grid.Column="1"
                    Command="{Binding ImportCommand}"
                    Style="{StaticResource MaterialDesignRaisedButton}"
                    Margin="0,0,8,0"
                    Padding="20,8"
                    ToolTip="开始导入选中的视频文件">
                <StackPanel Orientation="Horizontal">
                    <md:PackIcon Kind="Import" VerticalAlignment="Center" Margin="0,0,6,0"/>
                    <TextBlock Text="开始导入" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>

            <!-- Cancel button -->
            <Button Grid.Column="2"
                    x:Name="CancelButton"
                    Click="CancelButton_Click"
                    Style="{StaticResource MaterialDesignOutlinedButton}"
                    Padding="20,8"
                    ToolTip="取消操作并关闭">
                <StackPanel Orientation="Horizontal">
                    <md:PackIcon Kind="Close" VerticalAlignment="Center" Margin="0,0,6,0"/>
                    <TextBlock Text="关闭" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>
    </Grid>
</Window>
